<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Game loading...</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aws-sdk/2.1502.0/aws-sdk.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        iframe {
            border: none;
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <iframe>Loading....</iframe>
    <script>
        (async () => {
            const iframe = document.querySelector("iframe");
            iframe.width = window.innerWidth;
            iframe.height = window.innerHeight;
            iframe.allowFullscreen = true;

            const gameID = window.location.hash.substring(1).split('?')[0];
            const serverID = new URLSearchParams(window.location.hash.substring(1).split('?')[1]).get('server');
            const serverList = await fetch('/servers.txt');
            const serversText = await serverList.text();
            const servers = serversText.split('\n');
            if (serverID) {
                iframe.src = `https://${servers[serverID]}/games/${gameID}/index.html`;
            } else {
                iframe.src = `https://${servers[Math.floor(Math.random() * servers.length)]}/games/${gameID}/index.html`;
            }

            AWS.config.region = 'us-west-2';
            AWS.config.credentials = new AWS.CognitoIdentityCredentials({
                IdentityPoolId: 'us-west-2:cb7ff0d0-87c6-43c8-a9e4-dece8bd1b8c7'
            });

            const dynamodb = new AWS.DynamoDB.DocumentClient();

            function requestGameData() {
                dynamodb.get({
                    TableName: 'games_list',
                    Key: {
                        gameID
                    }
                }, (err, data) => {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    const item = data.Item;
                    if (item) {
                        document.title = item.fName;
                        // add favicon
                        // var link = document.querySelector("link[rel~='icon']");
                        // if (!link) {
                        //     link = document.createElement('link');
                        //     link.rel = 'icon';
                        //     document.head.appendChild(link);
                        // }
                        // changeFavicon(`https://d1yh00vn2fvto7.cloudfront.net/games/${gameID}${item.thumbPath}`);
                        setDescription(item.description + " Play now on CCPorted!");
                    }
                });
            }
            function setDescription(description) {
                const meta = document.querySelector("meta[name='description']") || document.createElement("meta");
                meta.name = "description";
                meta.content = description;
                if (!document.querySelector("meta[name='description']")) {
                    document.head.appendChild(meta);
                }
            }
            function changeFavicon(src) {
                var link = document.createElement('link'),
                    oldLink = document.getElementById('dynamic-favicon');
                link.id = 'dynamic-favicon';
                link.rel = 'icon';
                link.href = src;
                if (oldLink) {
                    document.head.removeChild(oldLink);
                }
                document.head.appendChild(link);
            }
            requestGameData();
        })();

    </script>
</body>

</html>